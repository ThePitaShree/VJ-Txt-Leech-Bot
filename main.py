# Don't Remove Credit Tg - @VJ_Botz
# Subscribe YouTube Channel For Amazing Bot https://youtube.com/@Tech_VJ
# Ask Doubt on telegram @KingVJ01

import os
import re
import sys
import json
import time
import asyncio
import requests
import subprocess

import core as helper
from utils import progress_bar
from vars import API_ID, API_HASH, BOT_TOKEN
from aiohttp import ClientSession
from pyromod import listen
from subprocess import getstatusoutput

from pyrogram import Client, filters
from pyrogram.types import Message
from pyrogram.errors import FloodWait
from pyrogram.errors.exceptions.bad_request_400 import StickerEmojiInvalid
from pyrogram.types.messages_and_media import message
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup

bot = Client(
    "bot",
    api_id=API_ID,
    api_hash=API_HASH,
    bot_token=BOT_TOKEN)


@bot.on_message(filters.command(["start"]))
async def start(bot: Client, m: Message):
    buttons = InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton("ğŸ“¤ Upload Now", callback_data="upload_now"),
                InlineKeyboardButton("ğŸ‘¨â€ğŸ’» Developer", url="https://t.me/EL_Pita_Shree")
            ]
        ]
    )
    await bot.send_photo(
        chat_id=m.chat.id,
        photo="https://i.ibb.co/MDpVXD9z/file-1148.jpg",
        caption=f"<b><blockquote>Hello {m.from_user.mention} ğŸ‘‹\n\nI Am A Bot For Download Links From Your **.TXT** File And Then Upload That File On Telegram. Basically, If You Want To Use Me, First Send /upload Command And Then Follow A Few Steps..\nUse /stop to stop any ongoing task.</blockquote></b>",
        reply_markup=buttons
    )

@bot.on_callback_query()
async def callback_query_handler(bot: Client, query):
    if query.data == "upload_now":
        await query.message.delete()
        await upload(bot, query.message)

@bot.on_message(filters.command("stop"))
async def restart_handler(_, m):
    await m.reply_text("**Stopped**ğŸš¦", True)
    os.execl(sys.executable, sys.executable, *sys.argv)

@bot.on_message(filters.command(["upload"]))
async def upload(bot: Client, m: Message):
    editable = await m.reply_text('ğ•¤á´‡É´á´… á´›xá´› Ò“ÉªÊŸá´‡ âš¡ï¸')
    input: Message = await bot.listen(editable.chat.id)
    x = await input.download()
    await input.delete(True)

    path = f"./downloads/{m.chat.id}"

    try:
       with open(x, "r") as f:
           content = f.read()
       content = content.split("\n")
       links = []
       for i in content:
           links.append(i.split("://", 1))
       os.remove(x)
    except Exception as e:
           await m.reply_text(f"**Invalid file input or DRM protected file.** Error: {str(e)}")
           os.remove(x)
           return

    await editable.edit(f"**ğ•‹á´á´›á´€ÊŸ ÊŸÉªÉ´á´‹ğ•¤ Ò“á´á´œÉ´á´… á´€Ê€á´‡ğŸ”—ğŸ”—** **{len(links)}**\n\n**ğ•Šá´‡É´á´… ğ”½Ê€á´á´ á´¡Êœá´‡Ê€á´‡ Êá´á´œ á´¡á´€É´á´› á´›á´ á´…á´á´¡É´ÊŸá´á´€á´… ÉªÉ´Éªá´›Éªá´€ÊŸ Éªğ•¤** **1**")
    input0: Message = await bot.listen(editable.chat.id)
    raw_text = input0.text
    await input0.delete(True)

    await editable.edit("**Now Please Send Me Your Batch Name**")
    input1: Message = await bot.listen(editable.chat.id)
    raw_text0 = input1.text
    await input1.delete(True)

    await editable.edit("**ğ”¼É´á´›á´‡Ê€ Ê€á´‡ğ•¤á´ÊŸá´œá´›Éªá´É´ğŸ“¸**\n144,240,360,480,720,1080 please choose quality")
    input2: Message = await bot.listen(editable.chat.id)
    raw_text2 = input2.text
    await input2.delete(True)

    # Ensure valid resolution input
    try:
        if raw_text2 == "144":
            res = "256x144"
        elif raw_text2 == "240":
            res = "426x240"
        elif raw_text2 == "360":
            res = "640x360"
        elif raw_text2 == "480":
            res = "854x480"
        elif raw_text2 == "720":
            res = "1280x720"
        elif raw_text2 == "1080":
            res = "1920x1080" 
        else:
            res = "UN"
    except Exception:
        res = "UN"

    await editable.edit("Now Enter A Caption to add caption on your uploaded file")
    input3: Message = await bot.listen(editable.chat.id)
    raw_text3 = input3.text
    await input3.delete(True)

    await editable.edit("Now send the Thumb url/nEg Â» https://i.ibb.co/MDpVXD9z/file-1148.jpg \n Or if don't want thumbnail send = no")
    input6 = message = await bot.listen(editable.chat.id)
    raw_text6 = input6.text
    await input6.delete(True)

    await editable.delete()

    thumb = input6.text
    if thumb.startswith("http://") or thumb.startswith("https://"):
        getstatusoutput(f"wget '{thumb}' -O 'thumb.jpg'")
        thumb = "thumb.jpg"
    else:
        thumb == "no"

    if len(links) == 1:
        count = 1
    else:
        count = int(raw_text)

    try:
        for i in range(count - 1, len(links)):
            V = links[i][1].replace("file/d/","uc?export=download&id=").replace("www.youtube-nocookie.com/embed", "youtu.be").replace("?modestbranding=1", "").replace("/view?usp=sharing", "")
            url = "https://" + V

            # Process DRM protected links
            if "drmprotected.com" in url:
                # If it's DRM-protected, handle it accordingly (e.g., skip, or notify user)
                await m.reply_text(f"**Cannot process DRM-protected content at {url}.**")
                continue

            # Continue with other file processing as usual
            name1 = links[i][0].replace("\t", "").replace(":", "").replace("/", "").replace("+", "").replace("#", "").replace("|", "").replace("@", "").replace("*", "").replace(".", "").replace("https", "").replace("http", "").strip()
            name = f'{str(count).zfill(3)}) {name1[:60]}'

            Show = f"**â¥¥ ğŸ„³ğŸ„¾ğŸ…†ğŸ„½ğŸ„»ğŸ„¾ğŸ„°ğŸ„³ğŸ„¸ğŸ„½ğŸ„¶â¬‡ï¸â¬‡ï¸... Â»**\n\n**ğŸ“Name Â»** `{name}\nâ„Quality Â» {raw_text2}`\n\n**ğŸ”—URL Â»** `{url}`"
            prog = await m.reply_text(Show)

            res_file = await helper.download_video(url, name)
            filename = res_file
            await prog.delete(True)
            await helper.send_vid(bot, m, filename, thumb, name, prog)

            count += 1
            time.sleep(1)

    except Exception as e:
        await m.reply_text(f"**Downloading Interrupted**\n{str(e)}")

    await m.reply_text("**ğ”»á´É´á´‡ ğ”¹á´ğ•¤ğ•¤ğŸ˜**")

bot.run()